<!DOCTYPE html>
<html lang="zh-CN">
<script>
  //用原生好还是用jquery好？如果用jquery，还要下载jquery，但是我可能这个网站都还没登录过，这个页面都不会让用户访问，还要打回去的，不然的话，jquery还要下载浪费流量，所以用原生好
    
        var xhr = new XMLHttpRequest();
        //这是同步,用同步好一点，因为必须等我的结果出来了才让你执行后面代码
        //不然的话，可能结果还没出来，后面代码就加载完了
        xhr.open('get','api/checkIsLogin.php',false);
        
        //记得用同步任务要先监听响应完成
        //规范写法：就是把它写在前面的，异步时写前面写后面无所谓，同步时一定要写在send前面
        xhr.onload = function(){
    
            if(xhr.responseText != 'ok'){
    
              //打回登录页
              location = "login.html";
              return;
            }
        } 
    
    
        xhr.send();//一旦发送就要等到响应完成，才会执行后面的代码
    </script>
<style>
  th,td{
  max-width: 420px;
}
</style>

<head>
  <meta charset="utf-8">
  <title>Comments &laquo; Admin</title>
  <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.css">
  <link rel="stylesheet" href="../assets/vendors/font-awesome/css/font-awesome.css">
  <link rel="stylesheet" href="../assets/vendors/nprogress/nprogress.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
  <script src="../assets/vendors/nprogress/nprogress.js"></script>
</head>

<body>
  <script>NProgress.start()</script>

  <div class="main">
    <nav class="navbar">
      <button class="btn btn-default navbar-btn fa fa-bars"></button>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="profile.html"><i class="fa fa-user"></i>个人中心</a></li>
        <li><a href="login.html"><i class="fa fa-sign-out"></i>退出</a></li>
      </ul>
    </nav>
    <div class="container-fluid">
      <div class="page-title">
        <h1>所有评论</h1>
      </div>
      <!-- 有错误信息时展示 -->
      <!-- <div class="alert alert-danger">
        <strong>错误！</strong>发生XXX错误
      </div> -->
      <div class="page-action">
        <!-- show when multiple checked -->
        <div class="btn-batch" style="display: none">
          <button onclick="doBatch('approved');" class="btn btn-info btn-sm">批量批准</button>
          <button onclick="doBatch('rejected');" class="btn btn-warning btn-sm">批量拒绝</button>
          <button onclick="doBatch('trashed');" class="btn btn-danger btn-sm">批量删除</button>
        </div>
        <ul class="pagination pagination-sm pull-right">
          <li><a href="#">上一页</a></li>
          <li><a href="#">1</a></li>
          <li><a href="#">2</a></li>
          <li><a href="#">3</a></li>
          <li><a href="#">下一页</a></li>
        </ul>
      </div>
      <table class="table table-striped table-bordered table-hover">
        <thead>
          <tr>
            <th class="text-center" width="40"><input type="checkbox"></th>
            <th>作者</th>
            <th>评论</th>
            <th>评论在</th>
            <th>提交于</th>
            <th>状态</th>
            <th class="text-center" width="100">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr class="danger">
            <td class="text-center"><input type="checkbox"></td>
            <td>大大</td>
            <td>楼主好人，顶一个</td>
            <td>《Hello world》</td>
            <td>2016/10/07</td>
            <td>未批准</td>
            <td class="text-center">
              <a href="post-add.html" class="btn btn-info btn-xs">批准</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
          <tr>
              <td class="text-center"><input type="checkbox"></td>
              
            <td>大大</td>
            <td>楼主好人，顶一个</td>
            <td>《Hello world》</td>
            <td>2016/10/07</td>
            <td>已批准</td>
            <td class="text-center">
              <a href="post-add.html" class="btn btn-warning btn-xs">驳回</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
          <tr>
            <td class="text-center"><input type="checkbox"></td>
            <td>大大</td>
            <td>楼主好人，顶一个</td>
            <td>《Hello world》</td>
            <td>2016/10/07</td>
            <td>已批准</td>
            <td class="text-center">
              <a href="post-add.html" class="btn btn-warning btn-xs">驳回</a>
              <a href="javascript:;" class="btn btn-danger btn-xs">删除</a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="aside">
    <div class="profile">
      <img class="avatar" src="../uploads/avatar.jpg">
      <h3 class="name">布头儿</h3>
    </div>
    <ul class="nav">
      <li>
        <a href="index.html"><i class="fa fa-dashboard"></i>仪表盘</a>
      </li>
      <li>
        <a href="#menu-posts" class="collapsed" data-toggle="collapse">
          <i class="fa fa-thumb-tack"></i>文章<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-posts" class="collapse">
          <li><a href="posts.html">所有文章</a></li>
          <li><a href="post-add.html">写文章</a></li>
          <li><a href="categories.html">分类目录</a></li>
        </ul>
      </li>
      <li class="active">
        <a href="comments.html"><i class="fa fa-comments"></i>评论</a>
      </li>
      <li>
        <a href="users.html"><i class="fa fa-users"></i>用户</a>
      </li>
      <li>
        <a href="#menu-settings" class="collapsed" data-toggle="collapse">
          <i class="fa fa-cogs"></i>设置<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-settings" class="collapse">
          <li><a href="nav-menus.html">导航菜单</a></li>
          <li><a href="slides.html">图片轮播</a></li>
          <li><a href="settings.html">网站设置</a></li>
        </ul>
      </li>
    </ul>

  </div>

  <script src="../assets/vendors/jquery/jquery.js"></script>
  <script src="../assets/vendors/bootstrap/js/bootstrap.js"></script>
  <script>NProgress.done()</script>
</body>

</html>

<!--   1.导入模板
 -->
<script src="../assets/vendors/template-web.js"></script>

<!-- 2.准备模板 -->
<script type="text/html" id="tplData">
  {{each list value}}

    {{if value.status=="held"}}
    <tr class="danger" >
      {{else}}
      <tr>
      {{/if}}
        <td class="text-center"><input type="checkbox" value="{{value.id}}"></td>        
        <td>{{value.author}}</td>
        <td>{{value.content}}</td>
        <td>《{{value.title}}》</td>
        <td>{{value.created}}</td>

      {{if value.status=='approved'}}
          <td>已批准</td>
          {{else if value.status=='rejected'}}
          <td>已拒绝</td>
          {{else}}
          <td>待审核</td>
      {{/if}}

      <td class="text-center">

        {{if value.status == 'held'}}
        <a href="javascript:editComment('approved',{{value.id}});" class="btn btn-info btn-xs">批准</a>
        {{else if value.status == 'approved'}}
        <a href="javascript:editComment('rejected',{{value.id}});" class="btn btn-warning btn-xs">拒绝</a>
        {{ /if }}
        <a href="javascript:editComment('trashed',{{value.id}});" class="btn btn-danger btn-xs">删除</a>
      </td>
    </tr>
    {{/each}}


</script>
<!-- 再准备一套页码的模板 -->
<script type="text/html" id="tplPage">

  {{if currentPage ==1}}
  <li><a href="javascript:loadData({{totalPage}});">上一页</a></li>
  {{ else }}
  <li><a href="javascript:loadData( {{currentPage - 1}} );">上一页</a></li>
{{ /if }}

  <% for(var i=1; i<=totalPage;i++) {%>
    {{if i==currentPage}}
    <li class="active"><a href="javascript:loadData(<%=i%>);"><%=i%></a></li>
    {{else}}
    <li><a href="javascript:loadData(<%=i%>);"><%=i%></a></li>
    {{/if}}
    <%}%>

    {{if currentPage==totalPage}}
    <li><a href="javascript:loadData(1);">下一页</a></li>
    {{ else }}
  <li><a href="javascript:loadData( {{currentPage + 1 }} );">下一页</a></li>
{{ /if }}
</script>

<script>
  //声明一个全局变量用来记录当前页
  var globalPage; //当前页
  var globalTotalPage;//当前总页

  loadData(1);

  /*
    page参数：传入几，就代表查询出第几页的数据
  */
  function loadData(page) {

    //记录当前页
    globalPage = page;

    $.get({

      url: "api/getComments.php",
      data: { pageIndex: page, pageSize: 10 },
      dataType: "json",
      success: function (obj) {
        //记录总页数
        globalTotalPage=obj.totalPage;
        
        //调用模板
        var html = template('tplData', { list: obj.data });
        $('tbody').html(html);

        //page是几，就代表当前页是几，所以把page给模板的currentPage,就能让第几高亮了
        var html2 = template('tplPage', { totalPage: obj.totalPage, currentPage: page });
        $('.pagination').html(html2);
      }
    });
  }

  //找到thead下面所有的checkbox，但thead下面只有这一个，就只找到这一个
  $('thead :checkbox').click(function () {
    //如果我是选中的，那么tbody里面也有都选中
    //如果我是没选中，那么tbody里面也都不要选中
    $('tbody :checkbox').prop('checked', this.checked); 

    //如果选中了
    if (this.checked) {
      //就让批量操作显示出来
      $('.btn-batch').fadeIn();

    } else {
      $('.btn-batch').fadeOut();
    }
  });
    //事件是加在tbody身上的，只不过，只能由tbody里面的checkbox触发
    
  $('tbody').on('click',':checkbox',function(){
    if($('tbody :checked').length==$('tbody :checkbox').length){
      $('thead :checkbox').prop('checked',true);

    }else{
      $('thead :checkbox').prop('checked',false);
    }
    //只要勾选的数量大于0，就要让批量操作显示出来
    if($('tbody :checked').length>0){
      $('.btn-batch').fadeIn();
    }else{
      $('.btn-batch').fadeOut();
    }
  });
    //单行修改的点击事件
    function editComment(st,id){
      $.post({
        url:"api/updateComments.php",
        data:{status:st,id:id},
        success:function(obj){
         if(obj =='ok'){
          loadData(globalPage);
         }else{
           alert('修改失败')
         }
        }
      });
    }

    function doBatch(st){
      //一定要先给一个空字符串，不然，它默认是undefined，就会用undefined来拼接
      var str="";
          //先获得所有被选中的checkbox
    //each就是在遍历你找到的每个元素，ele就是被遍历出来的每个元素
    $('tbody :checked').each(function(index,ele){
      console.log(ele);
      str+=ele.value+',';
    });
    console.log('str',str);

    var ids=str.substr(0,str.length-1);
    console.log('ids',ids);
      $.post({
        url:"api/updateComments.php",
        data:{status:st,id:ids},
        success:function(obj){
          if(obj =='ok'){
           //修改成功,应该刷新
          //应该刷新当前页！
          //如果当前页是最后一页并且是删除并且还要是全选，那么就要刷新前一页，其他都是刷新当前页
          if(globalPage==globalTotalPage && st== 'trashed'&& $('thead :checked').length>0){
          loadData(globalPage-1);
          }else{
            loadData(globalPage)
          }
          // 刷新完了后把全选取消掉
          $('thead :checkbox').prop('checked',false);
          //刷新完了后让批量操作隐藏
          $('.btn_batch').fadeOut();
        }else{
          //修改失败
          alert('修改失败');
        }
        }
      })
    }
//有一个bug,批量删除最后一页,全选,需要刷新前一页



</script>